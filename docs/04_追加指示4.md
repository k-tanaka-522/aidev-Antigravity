# 追加指示4：AIオーケストレーション品質向上 - ナレッジベース構築

## 背景・課題

### 現状
- IPA標準準拠のドキュメント生成は実現できた
- テンプレートベースでの出力は機能している

### 課題
開発プロセス全体において、各分野での品質が不安定：
- **IaC**: セキュリティリスク（過剰権限、ハードコードされたシークレット等）
- **UI/UX**: アクセシビリティ、デザインパターンの未適用
- **アプリケーション**: セキュリティ、パフォーマンス、保守性の考慮不足
- **データベース**: スキーマ設計、クエリ最適化の未考慮
- **テスト**: 網羅性、テスト戦略の不足

### 根本原因
- **受動的なアプローチ**: 「テンプレートを埋める」だけで終わっている
- **ベストプラクティス不在**: AIが参照すべき品質基準がない
- **チェック機構不在**: 生成物の品質検証プロセスがない

---

## 目的

### 最終ゴール
**開発プロセス全体を、AIオーケストレーションで自動化し、全分野で高品質なアウトプットを実現する**

### 具体的な目標
1. **プロアクティブなヒアリング**: ユーザーから要件を引き出す
2. **提案型アプローチ**: 複数の選択肢と比較を提示
3. **ベストプラクティス適用**: 各分野の最新知識を反映
4. **品質保証**: 自動チェックリストで検証
5. **セキュリティファースト**: セキュリティを常に考慮

---

## 解決策：`.agent/knowledge/` ナレッジベース構築

### コンセプト
各分野のベストプラクティス、チェックリスト、パターン集をナレッジベースとして構築し、
AIが**必ず参照**することで、高品質なアウトプットを保証する。

### ディレクトリ構成

```
.agent/knowledge/
│
├── architecture/                    # アーキテクチャ全般
│   ├── design-patterns.md          # デザインパターン集
│   ├── microservices-patterns.md   # マイクロサービス設計
│   ├── monolith-vs-microservices.md
│   └── scalability-patterns.md     # スケーラビリティパターン
│
├── ui-ux/                          # UI/UX設計
│   ├── design-principles.md        # デザイン原則
│   ├── accessibility/              # アクセシビリティ
│   │   ├── wcag-guidelines.md
│   │   └── aria-best-practices.md
│   ├── patterns/                   # UIパターン
│   │   ├── navigation-patterns.md
│   │   ├── form-design.md
│   │   ├── feedback-patterns.md
│   │   └── responsive-design.md
│   ├── user-research/              # ユーザー調査
│   │   ├── persona-creation.md
│   │   ├── questioning-guide.md    # ヒアリング質問集
│   │   └── usability-testing.md
│   └── anti-patterns.md            # 避けるべきUI/UX
│
├── application/                    # アプリケーション開発
│   ├── frontend/
│   │   ├── react-best-practices.md
│   │   ├── vue-best-practices.md
│   │   ├── state-management.md     # 状態管理パターン
│   │   ├── performance.md          # フロントエンドパフォーマンス
│   │   └── security.md             # XSS, CSRF対策等
│   ├── backend/
│   │   ├── api-design/
│   │   │   ├── rest-api-design.md
│   │   │   ├── graphql-design.md
│   │   │   ├── versioning.md       # APIバージョニング
│   │   │   └── questioning-guide.md # API設計ヒアリング
│   │   ├── authentication/         # 認証・認可
│   │   │   ├── oauth2.md
│   │   │   ├── jwt-best-practices.md
│   │   │   └── session-management.md
│   │   ├── error-handling.md       # エラーハンドリング
│   │   ├── logging.md              # ロギング戦略
│   │   └── caching.md              # キャッシング戦略
│   └── code-quality/
│       ├── clean-code.md
│       ├── solid-principles.md
│       └── refactoring-patterns.md
│
├── database/                       # データベース設計
│   ├── relational/
│   │   ├── normalization.md        # 正規化
│   │   ├── indexing-strategies.md  # インデックス戦略
│   │   ├── query-optimization.md   # クエリ最適化
│   │   └── migration-strategies.md # マイグレーション戦略
│   ├── nosql/
│   │   ├── document-db-patterns.md # DynamoDB, MongoDB等
│   │   ├── key-value-patterns.md
│   │   └── when-to-use-nosql.md
│   ├── data-modeling/
│   │   ├── er-diagram-best-practices.md
│   │   ├── schema-design-patterns.md
│   │   └── questioning-guide.md    # DB設計ヒアリング
│   └── questioning-guide.md        # データ要件ヒアリング
│
├── iac/                            # Infrastructure as Code
│   ├── terraform/
│   │   ├── security-checklist.md   # ★最優先
│   │   ├── module-design.md
│   │   ├── state-management.md
│   │   ├── best-practices.md
│   │   └── anti-patterns.md
│   ├── cloudformation/
│   │   ├── security-checklist.md
│   │   └── best-practices.md
│   ├── kubernetes/
│   │   ├── manifest-best-practices.md
│   │   ├── security.md
│   │   └── helm-charts.md
│   ├── common/
│   │   ├── aws-well-architected.md
│   │   ├── naming-conventions.md
│   │   ├── tagging-strategy.md
│   │   └── questioning-guide.md    # インフラ要件ヒアリング
│   └── questioning-guide.md        # IaC全般ヒアリング
│
├── testing/                        # テスト戦略
│   ├── test-pyramid.md             # テストピラミッド
│   ├── unit-testing/
│   │   ├── best-practices.md
│   │   ├── mocking-strategies.md
│   │   └── coverage-guidelines.md
│   ├── integration-testing/
│   │   └── best-practices.md
│   ├── e2e-testing/
│   │   ├── playwright-patterns.md
│   │   └── cypress-patterns.md
│   ├── performance-testing/
│   │   └── load-testing-guide.md
│   └── tdd-bdd/
│       ├── tdd-workflow.md
│       └── bdd-scenarios.md
│
├── security/                       # セキュリティ
│   ├── security-checklist.md       # ★最優先：総合チェックリスト
│   ├── owasp-top10.md             # OWASP Top 10対策
│   ├── secure-coding/
│   │   ├── input-validation.md
│   │   ├── sql-injection-prevention.md
│   │   ├── xss-prevention.md
│   │   └── csrf-prevention.md
│   ├── authentication-security.md
│   ├── secrets-management.md      # シークレット管理
│   └── dependency-security.md     # 依存関係のセキュリティ
│
├── cicd/                           # CI/CD
│   ├── pipeline-design.md
│   ├── deployment-strategies.md   # Blue/Green, Canary等
│   ├── gitflow-vs-trunk.md
│   └── automated-testing-in-cicd.md
│
└── project-management/             # プロジェクト管理
    ├── agile-practices.md
    ├── estimation-techniques.md
    └── documentation-standards.md
```

---

## 実装計画

### Phase 1: 基盤構築 - チェックリスト作成（最優先）

**目的**: 品質の最低ラインを保証する

**成果物**:
1. `security/security-checklist.md` - セキュリティ総合チェックリスト
2. `iac/terraform/security-checklist.md` - Terraformセキュリティチェック
3. `iac/cloudformation/security-checklist.md` - CloudFormationセキュリティチェック
4. `ui-ux/accessibility/wcag-checklist.md` - アクセシビリティチェック
5. `testing/coverage-guidelines.md` - テストカバレッジガイドライン

**各チェックリストの形式**:
```markdown
# [分野] チェックリスト

## 必須チェック項目（Critical）
- [ ] 項目1: 説明
- [ ] 項目2: 説明

## 推奨チェック項目（Recommended）
- [ ] 項目3: 説明

## Good / Bad Example
### Good ✅
```
[良い例]
```

### Bad ❌
```
[悪い例]
```
```

---

### Phase 2: ベストプラクティス追加

**成果物**:
1. 各分野のベストプラクティス文書
2. アンチパターン集
3. デザインパターン集

**優先順位**:
1. `iac/terraform/best-practices.md`
2. `application/backend/api-design/rest-api-design.md`
3. `ui-ux/patterns/` 配下のパターン集
4. `database/relational/indexing-strategies.md`

---

### Phase 3: 提案型質問集（Questioning Guides）

**目的**: プロアクティブなヒアリングを実現

**成果物**:
各分野の `questioning-guide.md` を作成

**形式**:
```markdown
# [分野] ヒアリング質問ガイド

## 基本情報確認
### 質問1: [質問文]
**Why（なぜ聞くか）**: この情報から〜を判断できる
**選択肢**:
- A: 〜の場合 → [推奨パターン]
- B: 〜の場合 → [推奨パターン]

### 質問2: [質問文]
...

## 提案フォーマット
ヒアリング結果に基づき、以下のように提案する：

**パターンA: [名前]**
- メリット: ...
- デメリット: ...
- 向いているケース: ...

**パターンB: [名前]**
- メリット: ...
- デメリット: ...
- 向いているケース: ...

**推奨**: 〜の理由から、パターンAを推奨します
```

---

### Phase 4: ワークフロー統合

**GEMINI.md の改訂**:

現状のGEMINI.mdに以下を追加：

```markdown
## ナレッジベース活用ルール（重要）

全てのタスク実行時に、`.agent/knowledge/` 配下の関連ナレッジを**必ず参照**すること。

### タスク種別とナレッジの対応

| タスク種別 | 必須参照ナレッジ |
|-----------|------------------|
| UI/UX設計 | `ui-ux/` + `accessibility/wcag-checklist.md` |
| API設計 | `application/backend/api-design/` + `security/owasp-top10.md` |
| DB設計 | `database/` + `database/questioning-guide.md` |
| IaC実装 | `iac/[tool]/` + `security/security-checklist.md` |
| テスト設計 | `testing/test-pyramid.md` + `testing/coverage-guidelines.md` |
| 認証実装 | `application/backend/authentication/` + `security/` |

### 品質保証プロセス（必須フロー）

**全てのタスクで以下のフローを厳守すること**:

1. **事前学習**（Before）
   - 関連ナレッジを読み、ベストプラクティスを理解
   - アンチパターンを確認

2. **ヒアリング**（During - Part 1）
   - `questioning-guide.md` に基づいて質問
   - **一問一答形式**でユーザーを疲れさせない
   - 回答に基づいて複数案を準備

3. **提案**（During - Part 2）
   - 複数のパターンを提示
   - メリット・デメリットを比較
   - 推奨案を明示（理由も説明）

4. **実装**（Do）
   - ベストプラクティスに従って実装
   - コード/設計を生成

5. **検証**（Check）
   - チェックリストで全項目を確認
   - アンチパターンに該当しないか確認
   - 問題があれば修正案を提示

6. **承認**（Accept）
   - ユーザーに最終確認
   - 決定事項を記録

## プロアクティブな提案

以下の場合、AIから積極的に提案すること：

- より良い代替案がある場合
- セキュリティリスクがある場合
- パフォーマンス上の懸念がある場合
- 保守性を向上できる場合
- アクセシビリティを改善できる場合

**提案フォーマット**:
```
💡 提案: [提案内容]

**理由**: [なぜこの提案をするか]
**メリット**: [採用した場合のメリット]
**デメリット**: [採用した場合のデメリット]
**推奨度**: ★★★☆☆ (5段階)
```
```

---

**ワークフロー改善例**:

例: `.agent/workflows/03-basic-design.md` のAPI設計セクション

**改善前**:
```markdown
## API設計
APIの設計をしてください。
```

**改善後**:
```markdown
## API設計

### 1. 事前学習（AI側で実施）
以下のナレッジを読み、最新のベストプラクティスを理解する：
- `.agent/knowledge/application/backend/api-design/rest-api-design.md`
- `.agent/knowledge/application/backend/api-design/versioning.md`
- `.agent/knowledge/security/owasp-top10.md`
- `.agent/knowledge/application/backend/api-design/questioning-guide.md`

### 2. ヒアリング（提案型・一問一答）
questioning-guide.md に基づき、以下を確認：

**質問1: ユースケース**
「このAPIでどのような操作を実現したいですか？」
→ 回答に基づいてREST/GraphQLを検討

**質問2: データ量**
「1リクエストあたりのデータ量はどの程度ですか？」
→ ページネーション要否を判断

**質問3: パフォーマンス要件**
「応答時間の要件はありますか？」
→ キャッシング戦略を検討

**質問4: セキュリティ要件**
「認証・認可の要件を教えてください」
→ 認証方式を提案

### 3. 複数案提示
ヒアリング結果に基づき、以下を提示：

**パターンA: RESTful API**
- メリット: シンプル、広く使われている、ツールが豊富
- デメリット: over-fetching/under-fetching の可能性
- 向いているケース: シンプルなCRUD、外部公開API

**パターンB: GraphQL**
- メリット: 柔軟なクエリ、over-fetching解消、型安全
- デメリット: 学習コスト、複雑性増加、N+1問題
- 向いているケース: 複雑なデータ要件、モバイルアプリ

**推奨**: [ヒアリング結果に基づいた推奨]

### 4. 設計実施
選択されたパターンでAPI設計を実施
- エンドポイント設計
- リクエスト/レスポンス定義
- エラーハンドリング設計

### 5. セキュリティチェック（必須）
`.agent/knowledge/security/owasp-top10.md` のチェックリストで検証：
- [ ] 認証・認可は適切か
- [ ] 入力値検証は実装されているか
- [ ] レート制限は考慮されているか
- [ ] 機密情報の露出はないか

### 6. アンチパターンチェック（必須）
`.agent/knowledge/application/backend/api-design/anti-patterns.md` に該当しないか確認

### 7. 最終確認
設計内容をユーザーに提示し、承認を得る
```

---

## 期待される成果

### 定量的成果
- セキュリティリスク: 90%削減（チェックリストによる自動検証）
- 設計品質: ベストプラクティス適用率 80%以上
- 手戻り削減: 提案型ヒアリングにより要件の齟齬を事前に解消
- 開発効率: 適切な技術選定により、実装時の手戻り削減

### 定性的成果
- **ユーザー満足度向上**: 提案型のアプローチでより良い選択が可能に
- **品質の安定化**: 属人性排除、一貫した品質
- **セキュリティ意識**: 設計段階からセキュリティを考慮
- **保守性向上**: ベストプラクティスに基づいたコード生成

---

## 実施指示

### 優先度

**最優先（Phase 1）**:
以下のチェックリストを作成すること：
1. `security/security-checklist.md`
2. `iac/terraform/security-checklist.md`
3. `iac/cloudformation/security-checklist.md`
4. `ui-ux/accessibility/wcag-checklist.md`
5. `testing/coverage-guidelines.md`

**高優先（Phase 2）**:
6. 各分野のベストプラクティス文書
7. アンチパターン集

**中優先（Phase 3）**:
8. 各分野の `questioning-guide.md`
9. パターン集

**低優先（Phase 4）**:
10. GEMINI.md 改訂
11. 全ワークフローへの統合

---

## 成功基準

### Phase 1完了基準
- [ ] 5つのチェックリストが作成され、`.agent/knowledge/` に配置されている
- [ ] 各チェックリストに最低10項目以上の具体的なチェック項目がある
- [ ] Good/Bad Exampleが含まれている

### Phase 2完了基準
- [ ] 各分野のベストプラクティス文書が作成されている
- [ ] アンチパターン集が作成されている

### Phase 3完了基準
- [ ] questioning-guide.md が主要分野（IaC, UI/UX, API, DB）に存在する
- [ ] 各ガイドに最低5つの質問が含まれている

### Phase 4完了基準
- [ ] GEMINI.md にナレッジベース活用ルールが記載されている
- [ ] 主要ワークフローにナレッジ参照が組み込まれている
- [ ] 実際のプロジェクトで動作確認が完了している

---

## 実装上の注意点

### ナレッジの更新性
- 技術トレンドは変化するため、ナレッジも定期的に更新が必要
- 各ナレッジファイルに「最終更新日」を記載すること

### 過度な複雑化を避ける
- チェックリストは「本当に重要な項目」に絞る
- ナレッジは簡潔に、実践的に

### ユーザー負担軽減
- 一問一答形式を徹底
- 専門用語は平易な言葉で説明
- 選択肢を明確に提示

---

**この追加指示に基づいて、Phase 1から順次実装を開始してください。**
