# CI-CD設計書

## ドキュメント情報
| 項目 | 内容 |
|------|------|
| ドキュメントID | BD010 |
| バージョン | 1.0 |
| 作成日 | YYYY-MM-DD |
| 作成者 | {作成者名} |
| 承認者 | {承認者名} |
| 承認日 | YYYY-MM-DD |

## 変更履歴
| バージョン | 日付 | 変更者 | 変更内容 |
|-----------|------|--------|---------|
| 1.0 | YYYY-MM-DD | {名前} | 初版作成 |

---

## 1. 設計原則

### 1.1 本書の目的
CI/CD（継続的インテグレーション/継続的デリバリー）の設計方針を定義し、
高速かつ安全なソフトウェアデリバリーを実現する。

### 1.2 CI/CDの基本原則

| 原則 | 説明 |
|------|------|
| 自動化 | ビルド、テスト、デプロイを自動化 |
| 高速フィードバック | 問題を早期に検出 |
| 常にリリース可能 | mainブランチは常にデプロイ可能な状態 |
| 段階的デプロイ | dev → stg → prod と段階的に |
| ロールバック可能 | いつでも前バージョンに戻せる |

### 1.3 参考資料（調査時点の最新ベストプラクティス）
| 調査日 | 情報源 | 概要 |
|--------|--------|------|
| YYYY-MM-DD | {URL/ドキュメント名} | {要点} |

> ⚠️ 技術トレンドは変化するため、設計時に最新情報を再調査すること

---

## 2. ツール選定

### 2.1 選択肢
| ツール | 特徴 | 向いてるケース |
|--------|------|---------------|
| GitHub Actions | GitHub統合、柔軟 | GitHub利用チーム |
| GitLab CI | GitLab統合、オールインワン | GitLab利用チーム |
| AWS CodePipeline | AWS統合、マネージド | AWS中心、サポート重視 |
| Jenkins | 高カスタマイズ性 | 複雑な要件、既存資産 |
| CircleCI | 高速、使いやすい | スタートアップ、SaaS |

### 2.2 本プロジェクトでの採用方針

> ⚠️ ユーザーと協議の上、決定してください

【協議ポイント】
- ソースコード管理はどこ？（GitHub / GitLab / CodeCommit）
- AWS依存度は？
- チームの習熟度は？

### 2.3 決定事項
| 項目 | 決定内容 | 理由 | 承認者 | 日付 |
|------|---------|------|--------|------|
| CI/CDツール | {GitHub Actions / CodePipeline / ...} | {理由} | {承認者} | {日付} |

---

## 3. ブランチ戦略

### 3.1 概念
ブランチ戦略はチームの開発フローとリリースサイクルを規定する。

### 3.2 選択肢
| 戦略 | 特徴 | 向いてるケース |
|------|------|---------------|
| GitHub Flow | シンプル、main + feature | 小〜中規模、頻繁リリース |
| GitFlow | develop/release/hotfix分離 | 大規模、計画的リリース |
| Trunk Based | 短命ブランチ、常にmain | 高成熟チーム、CD前提 |

### 3.3 本プロジェクトでの採用方針

> ⚠️ ユーザーと協議の上、決定してください

【協議ポイント】
- リリース頻度は？（毎日 / 週次 / 月次）
- チーム規模は？
- レビュープロセスは？

### 3.4 決定事項
| 項目 | 決定内容 | 承認者 | 日付 |
|------|---------|--------|------|
| ブランチ戦略 | {GitHub Flow / GitFlow / ...} | {承認者} | {日付} |

### 3.5 ブランチと環境の対応

| ブランチ | 環境 | デプロイ方式 |
|---------|------|-------------|
| feature/* | - | - |
| develop（GitFlowの場合） | dev | 自動 |
| main | stg | 自動 |
| main (タグ) | prod | 手動承認後 |

---

## 4. パイプライン設計

### 4.1 パイプライン構成図

```
┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐
│ Source  │ → │  Build  │ → │  Test   │ → │  Scan   │ → │ Deploy  │
└─────────┘   └─────────┘   └─────────┘   └─────────┘   └─────────┘
     │             │             │             │             │
  コード取得    ビルド       テスト実行    セキュリティ    デプロイ
  トリガー    アーティファクト  単体/結合     スキャン      環境適用
                  生成                      SAST/DAST
```

### 4.2 ステージ定義

| ステージ | 責務 | 成功条件 | 失敗時アクション |
|---------|------|---------|-----------------|
| Source | コード取得、トリガー | チェックアウト成功 | 即停止 |
| Build | ビルド、アーティファクト生成 | ビルド成功 | 即停止、通知 |
| Test | 単体/結合テスト | 全テスト合格 | 即停止、通知 |
| Scan | セキュリティスキャン | Critical/High検出なし | 重大度で判断 |
| Deploy (dev) | dev環境デプロイ | ヘルスチェック合格 | ロールバック |
| Deploy (stg) | stg環境デプロイ | ヘルスチェック合格 | ロールバック |
| Approval | 本番デプロイ承認 | 承認取得 | 待機 |
| Deploy (prod) | prod環境デプロイ | ヘルスチェック合格 | ロールバック |

### 4.3 環境別パイプライン

**dev環境**
```
Push to feature/* → Build → Test → Scan → Deploy to dev
```

**stg環境**
```
Merge to main → Build → Test → Scan → Deploy to stg
```

**prod環境**
```
Tag作成 → Build → Test → Scan → [承認] → Deploy to prod → Verify
```

---

## 5. デプロイ戦略

### 5.1 概念
デプロイ戦略はリリース時のリスクとダウンタイムを制御する。

### 5.2 選択肢
| 戦略 | 特徴 | リスク | ダウンタイム | 向いてるケース |
|------|------|--------|-------------|---------------|
| In-Place | 直接上書き | 高 | あり | 開発環境 |
| Blue/Green | 2環境切替 | 低 | なし | 本番、即時切り戻し |
| Canary | 段階的ロールアウト | 低 | なし | 大規模、影響検証 |
| Rolling | 順次入れ替え | 中 | なし | コンテナ、K8s |

### 5.3 本プロジェクトでの採用方針

> ⚠️ ユーザーと協議の上、決定してください

【協議ポイント】
- ダウンタイム許容度は？
- ロールバック速度の要件は？
- インフラコスト（Blue/Greenは2倍必要）

### 5.4 決定事項
| 環境 | デプロイ戦略 | 承認者 | 日付 |
|------|-------------|--------|------|
| dev | {In-Place / ...} | | |
| stg | {Blue/Green / ...} | | |
| prod | {Blue/Green / Canary / ...} | | |

### 5.5 Blue/Green設計（採用時）

```
                    ┌─────────────┐
                    │     ALB     │
                    └──────┬──────┘
                           │
           ┌───────────────┴───────────────┐
           ▼                               ▼
    ┌─────────────┐                 ┌─────────────┐
    │ Blue (現行) │                 │ Green (新)  │
    │   v1.0.0    │                 │   v1.1.0    │
    └─────────────┘                 └─────────────┘

1. Green環境にデプロイ
2. Greenでヘルスチェック
3. ALBのターゲットをGreenに切替
4. 問題あればBlueに即時切り戻し
5. 安定後、Blue環境を更新
```

---

## 6. 承認フロー

### 6.1 概念
本番デプロイには適切な承認プロセスが必要。
緊急時のバイパス手順も定義しておく。

### 6.2 承認設計

| 環境 | 承認要否 | 承認者 | 必要承認数 | タイムアウト |
|------|---------|--------|-----------|-------------|
| dev | 不要 | - | - | - |
| stg | 不要 | - | - | - |
| prod | 必要 | {役割} | {人数} | {時間} |

### 6.3 本番デプロイ承認ルール

| 項目 | 設計値 |
|------|--------|
| 承認者 | テックリード / PM / SRE |
| 必要承認数 | 1名以上 |
| タイムアウト | 24時間 |
| 承認前チェック | テスト全合格、スキャン問題なし |

### 6.4 緊急時（Hotfix）手順

| 項目 | 通常 | 緊急時 |
|------|------|--------|
| ブランチ | main経由 | hotfix/* → main |
| 承認者 | 通常承認者 | セキュリティ責任者単独可 |
| テスト | フルテスト | 影響範囲のみ |
| 事後対応 | - | 24時間以内にレビュー |

---

## 7. ロールバック設計

### 7.1 原則
- 「戻せる」前提で設計
- 前バージョンのアーティファクトを保持
- ロールバック判断基準を明確に

### 7.2 ロールバック方式

| 方式 | 特徴 | 復旧時間 |
|------|------|---------|
| Blue/Green切り戻し | ALBのターゲット切替 | 数秒〜数分 |
| 前バージョン再デプロイ | アーティファクトから再デプロイ | 数分〜数十分 |
| Gitリバート | コードを戻して再ビルド | 数十分 |

### 7.3 ロールバック判断基準

| 条件 | 閾値 | アクション |
|------|------|-----------|
| エラーレート | {X}%以上 | 自動ロールバック検討 |
| レイテンシ | {X}ms以上 | 調査、手動ロールバック検討 |
| ヘルスチェック失敗 | 連続{X}回 | 自動ロールバック |

### 7.4 ロールバック手順

1. 異常検知（監視アラート or 手動）
2. ロールバック判断（上記基準に基づく）
3. ロールバック実行
   - Blue/Green: ALBターゲット切替
   - ECS: 前タスク定義に戻す
4. ロールバック完了確認
5. 原因調査、修正

### 7.5 DB変更時の注意

| 方式 | 説明 | 推奨 |
|------|------|------|
| Forward-only | 追加のみ、削除は後で | ✅ 推奨 |
| Backward compatible | 新旧両対応 | ✅ 推奨 |
| Breaking change | 旧バージョン非互換 | ⚠️ 要注意 |

> ⚠️ DBスキーマ変更を含むデプロイは、ロールバックが困難になる場合がある。
> Forward-only migrationを推奨。

---

## 8. セキュリティスキャン

### 8.1 スキャン種別と配置

```
[Build] → [SAST] → [依存関係] → [Image Scan] → [Deploy] → [DAST]
```

| 種別 | タイミング | 対象 | ツール例 |
|------|-----------|------|---------|
| SAST | ビルド後 | ソースコード | SonarQube, CodeGuru Reviewer |
| 依存関係スキャン | ビルド後 | ライブラリ | Dependabot, Snyk |
| コンテナスキャン | Push前 | Dockerイメージ | Trivy, ECR Scan |
| DAST | デプロイ後 | 稼働アプリ | OWASP ZAP |

### 8.2 脆弱性対応ポリシー

| 重大度 | 対応 | 期限 |
|--------|------|------|
| Critical | 即時ブロック、修正必須 | 即時 |
| High | ブロック、修正必須 | 24時間以内 |
| Medium | 警告、修正推奨 | 1週間以内 |
| Low | 情報、対応任意 | 次スプリント |

---

## 9. シークレット管理

### 9.1 原則
- パイプライン定義にシークレットをハードコードしない
- 環境変数またはシークレットマネージャー経由
- 最小権限の原則

### 9.2 シークレット管理方式

| シークレット種別 | 管理方式 | 備考 |
|-----------------|---------|------|
| AWS認証情報 | OIDC (GitHub Actions) | 長期キー不要 |
| DBパスワード | Secrets Manager | ローテーション対応 |
| APIキー | Secrets Manager / Parameter Store | |
| Dockerレジストリ認証 | GitHub Secrets / CodeBuild環境変数 | |

### 9.3 GitHub Actions + AWS OIDC設定例

```yaml
permissions:
  id-token: write
  contents: read

steps:
  - uses: aws-actions/configure-aws-credentials@v4
    with:
      role-to-assume: arn:aws:iam::123456789012:role/GitHubActionsRole
      aws-region: ap-northeast-1
```

---

## 10. 通知設計

### 10.1 通知タイミング

| イベント | 通知先 | 重要度 |
|---------|--------|--------|
| ビルド失敗 | 開発者 | 高 |
| テスト失敗 | 開発者 | 高 |
| セキュリティスキャン検出 | 開発者 + セキュリティ | 高 |
| デプロイ成功（dev） | 開発者 | 低 |
| デプロイ成功（prod） | チーム全体 | 中 |
| デプロイ失敗 | チーム全体 | 高 |
| 承認待ち | 承認者 | 高 |
| ロールバック実行 | チーム全体 | 高 |

### 10.2 通知先設定

| 環境 | 通知先 |
|------|--------|
| dev | #dev-notification (Slack) |
| stg | #stg-notification (Slack) |
| prod | #prod-notification (Slack) + メール |

---

## 11. 監査ログ

### 11.1 記録項目

| 項目 | 内容 |
|------|------|
| デプロイ日時 | YYYY-MM-DD HH:MM:SS |
| デプロイ者 | GitHub username / 自動 |
| 承認者 | 承認者名（prod） |
| 環境 | dev / stg / prod |
| アーティファクト | コミットハッシュ、イメージタグ |
| 結果 | 成功 / 失敗 / ロールバック |

### 11.2 ログ保存

| 項目 | 設計値 |
|------|--------|
| 保存先 | S3 (バージョニング有効) |
| 保持期間 | {年数}（コンプライアンス要件に依存） |
| 暗号化 | SSE-S3 / SSE-KMS |
| アクセス制御 | 監査担当のみ参照可 |

---

## 12. パイプライン定義例

### 12.1 GitHub Actions例

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: myapp

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build
        run: |
          # ビルドコマンド

      - name: Test
        run: |
          # テストコマンド

      - name: SAST Scan
        uses: SonarSource/sonarcloud-github-action@master

      - name: Build & Push Docker Image
        run: |
          # ECRへプッシュ

  deploy-dev:
    needs: build
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Deploy to dev
        run: |
          # devデプロイ

  deploy-stg:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: stg
    steps:
      - name: Deploy to stg
        run: |
          # stgデプロイ

  deploy-prod:
    needs: deploy-stg
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: prod
      # 承認が必要
    steps:
      - name: Deploy to prod
        run: |
          # prodデプロイ
```

---

## 13. 承認

| 役割 | 氏名 | 署名 | 日付 |
|------|------|------|------|
| 開発リード | | | |
| SRE / インフラ | | | |
| PM | | | |
